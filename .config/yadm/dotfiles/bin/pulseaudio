#!/bin/bash

sleep_duration=3

main() {
    while true
    do
        pa_exists=$(pgrep pulseaudio)
        if [ -z "$pa_exists" ]
        then
            echo "pulseaudio not found, checking again"
            sleep 1
        else
            echo "pulseaudio found, setting card profile and volume"
            set_things
            amixer -c 0 set Master 64DB
            sleep $sleep_duration
            check_card_profile
            break
        fi
    done
}

set_things() {
    pactl set-card-profile 0 HiFi
    # amixer -c 0 set Master 64DB
}

check_card_profile() {
    while true
    do
        card_profile_exists=$(pacmd list-cards | rg 'active profile' | rg HiFi)
        if [ -z "$card_profile_exists" ]
        then
            echo "HiFi card profile was not set successfully, setting again"
            set_things
            sleep $sleep_duration
        else
            echo "HiFi card profile was set successfully"
            # restart polybar
            polybar-msg cmd restart
            break
        fi
    done
}

main
# set_things
